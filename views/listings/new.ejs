<%- layout("./layouts/boilerplate.ejs") %>

<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Create Your Listing</h1>
        <form method="POST" action="/listings" class="p-4 border rounded shadow bg-white needs-validation" style="background: #f8f9fa;" novalidate>
            <div class="mb-3">
                <label for="title" class="form-label">Job Title</label>
                <input type="text" class="form-control" id="title" placeholder="Enter job title" name="listings[title]" required autocomplete="off">
                <div class="invalid-feedback">Enter a valid job title!</div>
            </div>

            <!-- Company Name Field -->
            <div class="mb-3 position-relative">
                <label for="company" class="form-label">Company Name</label>
                <input type="hidden" id="logo" name="listings[logo]">
                <input type="text" class="form-control" id="company" placeholder="Enter company name" name="listings[company]" required autocomplete="off">
                <div id="suggestions" class="list-group position-absolute" style="z-index: 1000;"></div>
                <div class="invalid-feedback">Enter a valid company name!</div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" placeholder="Enter description" name="listings[description]" rows="4" required></textarea>
                <div class="invalid-feedback">Description is required!</div>
            </div>

            <div class="mb-3">
                <label for="requirements" class="form-label">Requirements</label>
                <textarea class="form-control" id="requirements" placeholder="Enter requirements" name="listings[requirements]" rows="4" required></textarea>
                <div class="invalid-feedback">Enter valid requirements!</div>
            </div>

            <div class="mb-3">
                <label for="salary" class="form-label">Salary</label>
                <input type="number" class="form-control" id="salary" placeholder="Enter salary" name="listings[salary]" min="0" required>
                <div class="invalid-feedback">Enter a valid salary!</div>
            </div>

            <div class="mb-3">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" name="listings[created_at]" required>
                <div class="invalid-feedback">Enter a valid date!</div>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Post</button>
            </div>
        </form>
    </div>

    <script>
        // Event listener on the company input field for autocomplete suggestions
        document.getElementById('company').addEventListener('input', function () {
            const query = this.value.trim();
            if (query.length < 2) {
                document.getElementById('suggestions').innerHTML = '';
                return;
            }
    
            // Fetching company suggestions using Clearbit API
            fetch(`https://autocomplete.clearbit.com/v1/companies/suggest?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    const suggestions = data.map(company => `
                        <button type="button" class="list-group-item list-group-item-action d-flex align-items-center" 
                                onclick="selectCompany('${company.name}', '${company.logo}')">
                            <img src="${company.logo}" alt="${company.name} logo" class="me-2" 
                                 style="width: 30px; height: 30px; border-radius: 50%;">
                            <span>${company.name}</span>
                        </button>
                    `).join('');
                    document.getElementById('suggestions').innerHTML = suggestions;
                })
                .catch(err => console.error('Error fetching companies:', err));
        });

        // Function to select a company from the suggestions
        function selectCompany(company, logo) {
            document.getElementById('company').value = company;
            document.getElementById('logo').value = logo;
            document.getElementById('suggestions').innerHTML = '';
        }
    </script>
</body>
